name: .NET Build and Release

on:
  push:
    branches: [ "develop" ]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    env:
      Solution_Name: mirada-finanza-control-central.slnx
      Configuration: Release

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Generate Version Strings
      shell: pwsh
      run: |
        $dt = Get-Date
        # Nur noch die nackte GitHub Build-Nummer (1, 2, 3...)
        $ver = "${{ github.run_number }}"
        
        # Für den Dateinamen und Release-Titel nutzen wir weiterhin das Datum zur Orientierung
        $fileDate = $dt.ToString("yyyyMMdd")
        $relName = $dt.ToString("dd.MM.yyyy HH:mm")
        
        # Der Dateiname enthält jetzt die einfache Build-Nummer
        $zipName = "Mirada-Finanza-Control-Central-$fileDate-$ver.zip"
        
        echo "NEW_VERSION=$ver" >> $env:GITHUB_ENV
        echo "RELEASE_NAME=$relName" >> $env:GITHUB_ENV
        echo "FILE_DATE=$fileDate" >> $env:GITHUB_ENV
        echo "ZIP_FILE_NAME=$zipName" >> $env:GITHUB_ENV

    - name: Publish Application
      run: |
        dotnet publish ${{ env.Solution_Name }} `
          -c ${{ env.Configuration }} `
          -o ./publish_output `
          /p:Version=${{ env.NEW_VERSION }}.0.0 `
          /p:AssemblyVersion=${{ env.NEW_VERSION }}.0.0 `
          /p:FileVersion=${{ env.NEW_VERSION }}.0.0

    - name: Package Application
      shell: pwsh
      run: |
        if (Test-Path "./publish_output/*.db") { Remove-Item "./publish_output/*.db" }
        Compress-Archive -Path ./publish_output/* -DestinationPath ${{ env.ZIP_FILE_NAME }}

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: b${{ env.NEW_VERSION }} # 'b' für Build (z.B. b45)
        name: Build ${{ env.NEW_VERSION }} vom ${{ env.RELEASE_NAME }}
        body: |
          ### Release Information
          - **Build-Nummer:** ${{ env.NEW_VERSION }}
          - **Zeitpunkt:** ${{ env.RELEASE_NAME }}
        files: ${{ env.ZIP_FILE_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
