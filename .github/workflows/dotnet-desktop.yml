name: .NET Build and Release

on:
  push:
    branches: [ "develop" ]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # Wichtig f체r die Release-Erstellung

    env:
      Solution_Name: mirada-finanza-control-central.slnx
      Configuration: Release
      Base_Version: 1.0 # Deine Hauptversion

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    # Generiert Datum (JJJJMMTT) und Uhrzeit sowie die fortlaufende Version
    - name: Generate Version Strings
      shell: pwsh
      run: |
        $dt = Get-Date
        # Technische Version (z.B. 1.0.42)
        $ver = "${{ env.Base_Version }}.${{ github.run_number }}"
        # Lesbares Datum f체r den Dateinamen (JJJJMMTT)
        $fileDate = $dt.ToString("yyyyMMdd")
        # Lesbarer Zeitpunkt f체r den Release-Titel
        $relName = $dt.ToString("dd.MM.yyyy HH:mm")
        # Der finale Name der ZIP-Datei
        $zipName = "Mirada-Finanza-Control-Central-$fileDate-$ver.zip"
        
        echo "NEW_VERSION=$ver" >> $env:GITHUB_ENV
        echo "RELEASE_NAME=$relName" >> $env:GITHUB_ENV
        echo "FILE_DATE=$fileDate" >> $env:GITHUB_ENV
        echo "ZIP_FILE_NAME=$zipName" >> $env:GITHUB_ENV

    # Baut das Projekt und sammelt alle Abh채ngigkeiten (SQLite DLLs etc.) ein
    - name: Publish Application
      run: |
        dotnet publish ${{ env.Solution_Name }} `
          -c ${{ env.Configuration }} `
          -o ./publish_output `
          /p:Version=${{ env.NEW_VERSION }} `
          /p:AssemblyVersion=${{ env.NEW_VERSION }} `
          /p:FileVersion=${{ env.NEW_VERSION }}

    # Packt alles in die ZIP (ohne Datenbankdateien)
    - name: Package Application
      shell: pwsh
      run: |
        if (Test-Path "./publish_output/*.db") { Remove-Item "./publish_output/*.db" }
        Compress-Archive -Path ./publish_output/* -DestinationPath ${{ env.ZIP_FILE_NAME }}

    # Erstellt das Release auf GitHub
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.NEW_VERSION }}
        name: Build vom ${{ env.RELEASE_NAME }} (v${{ env.NEW_VERSION }})
        body: |
          ### Release Information
          - **Version:** ${{ env.NEW_VERSION }}
          - **Zeitpunkt:** ${{ env.RELEASE_NAME }}
          - **Datei:** ${{ env.ZIP_FILE_NAME }}
        files: ${{ env.ZIP_FILE_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
